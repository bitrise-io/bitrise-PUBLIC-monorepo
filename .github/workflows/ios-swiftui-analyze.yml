name: iOS SwiftUI Analyze with Bitrise Build Cache
#
# This workflow demonstrates Bitrise Build Cache integration with Xcode
# and includes XCLogParser for build timing analysis.
#

on:
  push:
    branches:
      - main
    paths:
      - 'src/samples-ios-swift-swiftui/**'
      - '.github/workflows/ios-swiftui-analyze.yml'
  pull_request:
    paths:
      - 'src/samples-ios-swift-swiftui/**'
      - '.github/workflows/ios-swiftui-analyze.yml'
  workflow_dispatch:

jobs:
  xcode_analyze:
    name: Xcode Analyze
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bitrise Build Cache for Xcode
        working-directory: src/samples-ios-swift-swiftui
        env:
          # Set Auth Token in Repository Secrets
          BITRISE_BUILD_CACHE_AUTH_TOKEN: ${{ secrets.BITRISE_BUILD_CACHE_AUTH_TOKEN }}
          # Set Workspace ID in Repository Variables
          BITRISE_BUILD_CACHE_WORKSPACE_ID: ${{ vars.BITRISE_BUILD_CACHE_WORKSPACE_ID }}
        run: |
          #!/usr/bin/env bash
          set -euxo pipefail

          # download Bitrise Build Cache CLI
          curl --retry 5 -sSfL 'https://raw.githubusercontent.com/bitrise-io/bitrise-build-cache-cli/main/install/installer.sh' | sh -s -- -b /tmp/bin

          # run the CLI to enable Bitrise build cache for Xcode
          /tmp/bin/bitrise-build-cache activate -d xcode --cache --cache-push
      - name: PATH test
        run: |
          #!/usr/bin/env bash
          set -euxo pipefail
          
          echo "$PATH"
      - name: Select Xcode 26
        run: sudo xcode-select -s /Applications/Xcode_26.2.app
      - name: Check Xcode Version
        run: xcodebuild -version


      - name: Analyze
        working-directory: src/samples-ios-swift-swiftui
        run: |
          # Create directory for result bundle
          mkdir -p build-results

          # Run analyze with result bundle path to generate xcactivitylog
          xcodebuild "analyze" \
            "-project" "samples-ios-swift-swiftui.xcodeproj" \
            "-scheme" "samples-ios-swift-swiftui" \
            "CODE_SIGNING_ALLOWED=NO" \
            "COMPILER_INDEX_STORE_ENABLE=NO"


      - name: Attach Xcelerate logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: bitrise-xcelerate-xcodebuild-logs
          path: '~/.local/state/xcelerate/logs'
          retention-days: 7
